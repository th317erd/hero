# Plan Updates — Critical Observations
# Tracks drift between plan and reality, architectural concerns, and strategic recommendations.
# Created: 2026-02-20

version: 1
dt: 2026-02-20

# =============================================================================
# OBSERVATION 1: "Core Complete" Is Misleading
# =============================================================================

- id: PU-001
  t: Most phases labeled "core complete" have critical deferred work
  severity: high
  d: >
    Every phase from 1-8 is marked "CORE COMPLETE" but each has deferred items
    that are load-bearing for the user experience. The deferred items aren't
    nice-to-haves — many are prerequisites for the system to actually work
    as designed. Examples:
  evidence:
    - >
      Phase 1 deferred: participant sidebar, @mention autocomplete, WebSocket
      broadcast to all participants. Without WS broadcast, multi-party sessions
      don't actually work in real-time — only the originating user sees updates.
    - >
      Phase 2 deferred: permission prompt UX (<hml-prompt>), BEFORE_TOOL hook.
      Without the prompt UX, the "prompt" action from the permission engine has
      no way to ask the user. The approval system was bolted on separately in
      the streaming path (see websearch permissions fix).
    - >
      Phase 3 deferred: inter-agent streaming, @mention routing. Without these,
      multi-agent sessions have no way for agents to actually communicate or for
      users to address specific agents.
    - >
      Phase 6 deferred: user settings UI. The API endpoints exist but there's
      no way for users to access them.
  recommendation: >
    Redefine "complete" per phase. A phase is complete when its USER-FACING
    features work end-to-end. Backend-only implementations without UI are
    "scaffolded", not "complete".

# =============================================================================
# OBSERVATION 2: Dual State Management Is The Root Bug
# =============================================================================

- id: PU-002
  t: state.messages vs frames — the source of most UI bugs
  severity: critical
  d: >
    The CLEANUP.md analysis identified this and it remains unfixed. The app has
    4 parallel state stores for conversation data (state.messages, GlobalState
    heroFrames, session-frames-provider.frames, DB frames table). At least 3
    bug reports trace back to this: prompt not turning green (state mismatch),
    result JSON blobs showing (render path confusion), duplicate renders
    (multiple triggers from different state sources).
  evidence:
    - ".claude/CLEANUP.md Smell 2.1: Dual State Management"
    - "Multiple render triggers with _renderCount > 10 guard"
    - "Bug fixes required touching both state.messages and frame paths"
    - "MessageStore design exists in .claude/designs/message-store.md but is unimplemented"
  recommendation: >
    This should be the FIRST stabilization target. The MessageStore interface
    design already exists. Implementing it would fix the root cause of most
    UI bugs and eliminate an entire category of future issues.

# =============================================================================
# OBSERVATION 3: Client Is Far Behind Server
# =============================================================================

- id: PU-003
  t: Server has rich multi-party + permissions + auth — client is mostly single-agent chat
  severity: high
  d: >
    The server has full multi-party sessions, permission evaluation, agent
    delegation, command execution, API keys, magic links, file uploads, and
    content type registration. The client is essentially still a single-agent
    chat UI with some bolt-on features. The gap between server capabilities
    and client exposure is massive.
  evidence:
    - "Phase 1 client: only the creation modal supports multi-agent"
    - "Phase 2 client: no permission prompt UI exists"
    - "Phase 6 client: no settings UI exists"
    - "Phase 8 client: file upload exists but no avatar picker"
    - "No participant sidebar, no @mention, no permission management UI"
  recommendation: >
    The next phase of work should focus on client parity with server. The
    server APIs are stable and tested — the client needs to catch up.

# =============================================================================
# OBSERVATION 4: Approval System Is Fragmented
# =============================================================================

- id: PU-004
  t: Three separate approval/permission paths that don't unify
  severity: high
  d: >
    There are three distinct mechanisms for gating agent actions:
    1. The abilities approval system (abilities/approval.mjs) — per-ability,
       per-session, using WebSocket for prompt/response
    2. The permission engine (permissions/index.mjs) — rule-based, specificity
       resolution, wired into BEFORE_COMMAND hook only
    3. Ad-hoc checks in streaming routes (messages-stream.mjs websearch fix) —
       manually calling checkApprovalRequired + requestApproval
    These don't compose. The permission engine should BE the approval system,
    but they're separate modules with different interfaces.
  evidence:
    - "Websearch approval was manually added to messages-stream.mjs"
    - "Permission engine only wired to BEFORE_COMMAND, not BEFORE_TOOL"
    - "abilities/approval.mjs has its own pending map, separate from permission_rules"
    - "Phase 2 deferred: 'Wire BEFORE_TOOL hook into interaction detector'"
  recommendation: >
    Unify into a single permission evaluation path. The permission engine should
    handle ALL gating decisions. The abilities approval system should become
    the "prompt" execution path for the permission engine, not a parallel system.

# =============================================================================
# OBSERVATION 5: No E2E Test Suite
# =============================================================================

- id: PU-005
  t: 1672 unit/integration tests but zero automated E2E tests
  severity: high
  d: >
    All testing is server-side (node:test with JSDOM for component tests).
    There are no automated Puppeteer E2E tests. Browser testing has been
    manual (developer runs Puppeteer ad-hoc during debugging). The plan
    called for E2E tests in every phase but none were written.
  evidence:
    - "Plan Phase 1 testing: 'E2E tests (Puppeteer)' — none exist"
    - "Plan Phase 2 testing: 'E2E tests' — none exist"
    - "All spec files are *-spec.mjs using node:test"
    - "Browser verification done manually during bug fix sessions"
  recommendation: >
    Create a Puppeteer E2E test harness. Even 10-15 smoke tests covering
    login, session creation, message send/receive, and prompt interaction
    would catch the class of bugs that keep recurring.

# =============================================================================
# OBSERVATION 6: Concept Art Vision vs Reality Gap
# =============================================================================

- id: PU-006
  t: Concept art shows polished multi-party UI — current UI is minimal
  severity: medium
  d: >
    The plan/concept-art/ directory has 11 AI-generated images showing a
    futuristic glass/neon chat interface with contact lists, participant
    avatars with online status, file sharing UI, info panels, and rich
    multi-party conversations with color-coded bubbles. The current UI is
    a functional but minimal chat interface with a session sidebar.
  evidence:
    - "11 concept art images in plan/concept-art/"
    - "Vision: glass/neon aesthetic, participant list, info panel, rich UI"
    - "Reality: functional dark theme, basic sidebar, basic chat bubbles"
  recommendation: >
    Document the concept art vision in a design spec (done: concept-art.yaml).
    Use it as a north star for UI work but don't try to match it literally.
    Focus on functional parity first (participant sidebar, @mention, settings),
    then polish.

# =============================================================================
# OBSERVATION 7: Bug Fix Velocity Problem
# =============================================================================

- id: PU-007
  t: Bug fixes are slow because root causes compound
  severity: high
  d: >
    The user expressed frustration with iteration velocity. Analysis shows
    this is structural — most bugs are symptoms of deeper issues (dual state,
    fragmented approval, missing E2E tests). Fixing symptoms takes many
    iterations because the fix often doesn't stick or creates new issues.
  evidence:
    - "User: 'VERY MANY iterations... VERY LITTLE progress'"
    - "Websearch approval fix: bolt-on in streaming route (symptom fix)"
    - "Result frame JSON: hidden via empty return (symptom fix)"
    - "User avatar: changed state source (symptom fix)"
    - "Each fix required browser verification because no E2E tests"
  recommendation: >
    Stop fixing symptoms. Address root causes first:
    1. Implement MessageStore (kills state management bugs)
    2. Unify approval/permission system (kills approval bypass bugs)
    3. Add E2E tests (prevents regression, reduces verification time)
    Then resume feature work on a stable foundation.

# =============================================================================
# OBSERVATION 8: Plan Was Executed Bottom-Up, Not Top-Down
# =============================================================================

- id: PU-008
  t: Implementation went server-first, left client incomplete
  severity: medium
  d: >
    The plan's dependency graph was followed for server work, but the
    "Implementation" phase for each feature focused on server + tests,
    deferring client work. This created a situation where the server is
    mature but the user can't access most features. The plan should have
    required end-to-end completion per phase before moving to the next.
  evidence:
    - "Phase 1: 'SERVER COMPLETE' but participant sidebar pending"
    - "Phase 6: 'CORE COMPLETE' but no settings UI"
    - "8 phases 'complete' with substantial client work remaining in each"
  recommendation: >
    For stabilization work, adopt a vertical-slice approach: pick a feature,
    build it end-to-end (server + client + tests), verify in browser, then
    move on. No more horizontal layers.

# =============================================================================
# RESOLUTION STATUS
# =============================================================================

resolution:
  d: >
    All observations addressed in v1-plan.yaml revision 3 (2026-02-20).
    Plan rewritten from scratch, organized by what needs to happen.
    Revision 3 adds: product vision, active coordinator model, agent
    aliasing, page routing system, permission-as-form design.
  mapping:
    PU-001: "Honest completion percentages in plan. 'CORE COMPLETE' replaced with actual status."
    PU-002: "S1 (MessageStore) is first stabilization item."
    PU-003: "Client features are explicit work items (F1-F6), not 'pending' footnotes."
    PU-004: "S4 (Wire BEFORE_TOOL) + F2 (Permission Prompt UI) unifies the approval system."
    PU-005: "S6 (test helpers) + S7 (streaming tests) + S8 (WS tests) address test gaps."
    PU-006: "Concept art remains aspirational reference. Functional parity prioritized."
    PU-007: "Root-cause fixes (S1-S5) before feature work (F1-F6)."
    PU-008: "Every work item is a vertical slice (server + client + tests + verified)."

# =============================================================================
# ADDITIONAL FINDINGS (from 2026-02-20 audit)
# =============================================================================

- id: PU-009
  t: "WS broadcast only targets originating user — multi-party is broken"
  severity: critical
  d: >
    22 broadcastToUser() call sites, 0 broadcastToSession(). Other session
    participants must reload to see updates.
  resolution: "S2 in revised plan"

- id: PU-010
  t: "Permission 'prompt' action has no executor — silently fails"
  severity: critical
  d: >
    Engine returns {action: 'prompt'} then nothing happens. No UI, no
    interaction type, no wiring. Default-deny model fails on its default.
  resolution: "F2 in revised plan"

- id: PU-011
  t: "API key scopes stored but never enforced"
  severity: medium-security
  d: >
    Scopes column in api_keys table. Zero scope validation code anywhere.
  resolution: "F6 in revised plan"

- id: PU-012
  t: "No rate limiting, audit logging, or health check"
  severity: high-security
  d: "Missing from original plan entirely."
  resolution: "X1, X2, X3 in revised plan"

- id: PU-013
  t: "Self-approval prevention identified but never built"
  severity: high-security
  d: "Agent can approve its own destructive actions."
  resolution: "S5 in revised plan"

- id: PU-014
  t: "Error handling end-to-end is unspecified"
  severity: high
  d: >
    No spec for what user sees on: agent API failure, delegation chain
    break, permission error, DB write failure, WS disconnect mid-stream.
  resolution: "X4 in revised plan"

# =============================================================================
# VISION CLARIFICATION (from 2026-02-20 user discussion)
# =============================================================================

- id: PU-015
  t: "Product vision clarified — Hero is a channel-based bot playground"
  severity: foundational
  d: >
    User clarified Hero's identity: a chat application where users send
    messages in channels. Users can be humans or agents. Agents join by
    invitation (/invite {name} as:alias). One active coordinator per
    session, controlled by /promote. Abilities steer bot behavior via
    conditional prompts. Hero is a "super-charged Claude Code."
  impact:
    - "Multi-coordinator model → single active coordinator model"
    - "Agents invited by name with aliases, not by numeric ID"
    - "Create Session modal → Primary Agent + Sub-Agents"
    - "Abilities can suggest sub-agent selection for conditions"
  resolution: "vision section + F1/F5 in revised plan (revision 3)"

- id: PU-016
  t: "Permission prompts should reuse hml-prompt form system"
  severity: high
  d: >
    User confirmed: permission prompts ARE forms. Server intercepts form
    submissions before forwarding to channel members. Bots cannot forge
    permission responses — server validates submission source.
  resolution: "F2 redesigned as 'Permission Prompt as Form Submission' in revision 3"

- id: PU-017
  t: "Settings should be a page, not a modal — need page routing system"
  severity: medium
  d: >
    User wants a proper page system. Settings is a full page at /settings.
    Login should also be a page. Requires client-side page routing.
  resolution: "F4 expanded to 'Page Routing System + Settings + Login' in revision 3"

- id: PU-018
  t: "Agent aliasing per session is a new feature"
  severity: medium
  d: >
    Agents can be named per-session via /invite {name} as:alias.
    Alias stored on session_participants. Used in chat, @mention,
    participant list. Does not change agent's actual name.
  resolution: "F1 includes alias column migration + invite syntax update"
