# Existing Test Coverage — Overview
# What tests exist today. NOT every test — just the shape of coverage.
# 60 spec files, 1672 tests, 0 failures.

dt: 2026-02-20
runner: "find spec -name '*-spec.mjs' | xargs node --test --test-force-exit"
framework: "node:test (built-in)"
dom: "jsdom 28.1.0"
db: "better-sqlite3 in-memory per test"

# =============================================================================
# HELPERS AVAILABLE
# =============================================================================

helpers:
  test-helpers.mjs:
    - createTempDir, removeTempDir, randomString
    - wait(ms), mockConsoleError, mockConsoleWarn
  dom-helpers.mjs:
    - createDOM(html), destroyDOM, getDocument, getWindow
    - createElement, mount, triggerEvent, triggerKeyEvent
    - waitFrames, wait
  component-helpers.mjs:
    - registerComponent, mountComponent, cleanupComponents
    - shadowQuery, shadowQueryAll, shadowText
    - typeInto, pressEnter, click
    - waitForEvent, createSpy, waitForRender
  websocket-mock.mjs:
    - createEventBus (EventEmitter)
    - MockWebSocket (client), MockWebSocketServer
    - setupWebSocketMock → { bus, client, server }

missing_helpers:
  - SSE response mock (captures res.write/setHeader/end)
  - Express route test harness (mock req/res for handler calls)
  - Database fixture/seeder helpers

# =============================================================================
# ROUTES — 9 spec files, ~295 tests
# =============================================================================

routes:
  agents-spec:       { tests: 43, covers: "CRUD, config, FK cascade, encrypted keys" }
  auth-spec:         { tests: 35, covers: "login, password hashing, JWT gen/verify, password change" }
  frames-spec:       { tests: 9,  covers: "retrieval, compilation, filtering, pagination" }
  permissions-spec:  { tests: 68, covers: "rules CRUD, validation, evaluation, scope, ownership" }
  search-spec:       { tests: 15, covers: "search, pagination, session isolation" }
  sessions-spec:     { tests: 68, covers: "participant CRUD, session operations, multi-party" }
  uploads-spec:      { tests: 14, covers: "table schema, CRUD, cascade" }
  users-spec:        { tests: 13, covers: "profile API, magic links, API keys" }
  usage-spec:        { tests: 30, covers: "token charges, cost calc, spend queries, corrections" }

  NOT_TESTED:
    - messages-stream.mjs  # SSE streaming endpoint — CRITICAL GAP
    - messages.mjs         # Non-streaming message route — GAP

# =============================================================================
# COMPONENTS — 12 spec files, ~296 tests
# =============================================================================

components:
  hero-app-spec:             { tests: 28, covers: "route parsing, auth state, base path", type: logic }
  hero-base-spec:            { tests: 15, covers: "base component lifecycle", type: logic }
  hero-chat-spec:            { tests: 40, covers: "message filtering, visibility, scroll", type: logic }
  hero-header-spec:          { tests: 32, covers: "header component", type: logic }
  hero-input-spec:           { tests: 36, covers: "input component, auto-resize", type: logic }
  hero-modal-spec:           { tests: 35, covers: "modal open/close, forms", type: logic }
  hero-sidebar-spec:         { tests: 31, covers: "session list, search, archive", type: logic }
  hero-websocket-spec:       { tests: 40, covers: "WS connection, token extraction, URL", type: logic }
  hml-prompt-spec:           { tests: 29, covers: "prompt rendering, input types", type: "dom+logic" }
  render-loop-spec:          { tests: 12, covers: "render loop detection", type: logic }
  session-frames-provider:   { tests: 15, covers: "frame store, optimistic frames", type: logic }
  streaming-spec:            { tests: 13, covers: "interaction banners", type: "dom+logic" }

  type_note: >
    "logic" = tests methods/getters, NOT render output or DOM structure.
    "dom+logic" = tests some DOM assertions.
    Most component tests verify BEHAVIOR not RENDER OUTPUT.

# =============================================================================
# LIBRARY — 35 spec files, ~1000+ tests
# =============================================================================

lib:
  # Core
  api-spec:             { tests: 29, covers: "API client functions" }
  commands-spec:        { tests: 24, covers: "command parsing" }
  commands-new-spec:    { tests: 36, covers: "/participants, /invite, /kick, /history, /export" }
  compaction-spec:      { tests: 12, covers: "session compaction" }
  config-path-spec:     { tests: 11, covers: "config directory paths" }
  encryption-spec:      { tests: 17, covers: "encrypt/decrypt, password hashing" }
  form-validation-spec: { tests: 59, covers: "field validation rules" }
  html-sanitizer-spec:  { tests: 105, covers: "XSS prevention, tag filtering, attribute stripping" }
  markup-spec:          { tests: 9,  covers: "HML tag conversion" }
  routing-spec:         { tests: 22, covers: "URL routing logic" }
  utils-spec:           { tests: 36, covers: "utility functions" }
  state-sync-spec:      { tests: 14, covers: "Proxy ↔ GlobalState bidirectional sync" }
  avatars-spec:         { tests: 28, covers: "initials, colors, SVG generation" }
  content-registry-spec: { tests: 19, covers: "content type register/unregister/render" }
  sessions-spec:        { tests: 35, covers: "session DB operations" }
  participants-spec:    { tests: 47, covers: "participant CRUD, loadSessionWithAgent" }

  # Frames
  frames-spec:          { tests: 36, covers: "frame CRUD, compilation, types" }
  broadcast-spec:       { tests: 12, covers: "frame broadcast helpers" }
  context-spec:         { tests: 14, covers: "frame context building for AI" }
  pagination-spec:      { tests: 9,  covers: "backward pagination" }
  search-spec:          { tests: 17, covers: "frame search + count" }

  # Interactions
  interactions-spec:    { tests: 98, covers: "bus, detection, execution, functions, permissions" }
  delegate-spec:        { tests: 16, covers: "coordinator→member delegation" }
  execute-command-spec: { tests: 17, covers: "agent command invocation" }
  prompt-update-spec:   { tests: 12, covers: "prompt answer updates" }

  # Messaging pipeline
  command-handler-spec: { tests: 18, covers: "command detection, interception" }
  content-utils-spec:   { tests: 32, covers: "content transformation, stripping" }
  session-setup-spec:   { tests: 8,  covers: "session initialization" }

  # Auth
  api-keys-spec:        { tests: 29, covers: "creation, hash, validation, revocation, expiry" }
  magic-links-spec:     { tests: 21, covers: "generation, verification, expiry, cleanup" }

  # Security
  approval-hardening:   { tests: 16, covers: "hash gen, ownership, replay, duplicates" }
  bus-hardening:        { tests: 10, covers: "sender_id enforcement, respond verification" }

  # Plugins
  hooks-spec:           { tests: 18, covers: "hook registration, firing" }
  loader-spec:          { tests: 10, covers: "plugin loading" }
  loader-enhanced-spec: { tests: 34, covers: "dual discovery, deps, hot-reload" }

  # Abilities
  conditional-spec:     { tests: 15, covers: "conditional ability matching" }
  coordination-spec:    { tests: 14, covers: "multi-session coordination" }

  # Agents
  base-agent-spec:      { tests: 14, covers: "base agent class" }

# =============================================================================
# INTEGRATION — 1 spec file, 17 tests
# =============================================================================

integration:
  prompt-flow-spec: { tests: 17, covers: "SessionStore message CRUD, ID coercion, prompt state" }

# =============================================================================
# STORES — 1 spec file, 41 tests
# =============================================================================

stores:
  session-store-spec: { tests: 41, covers: "message CRUD, visibility toggle, prompt answering" }

# =============================================================================
# COVERAGE ASSESSMENT
# =============================================================================

assessment:
  strengths:
    - Excellent isolation/unit coverage for CRUD operations
    - Strong interaction system tests (98 tests, thorough)
    - Comprehensive HTML sanitizer (105 tests, security-critical)
    - Good permission engine logic (65 + 68 route = 133 tests)
    - Solid frame system (36 + 12 + 14 + 9 + 17 = 88 tests)

  weaknesses:
    - Zero route tests for messages-stream.mjs (the app's spine)
    - Zero route tests for messages.mjs (non-streaming path)
    - Component tests verify behavior, not render output
    - No integration tests for cross-system flows
    - No state propagation tests (GlobalState → component → DOM)
    - No SSE event flow tests
    - Only 1 file in integration/ (17 tests)
