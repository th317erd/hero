<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hero Component Demo</title>
  <base href="/">

  <!-- Theme Variables -->
  <link rel="stylesheet" href="/css/variables.css">
  <link rel="stylesheet" href="/css/base.css">
  <link rel="stylesheet" href="/css/layout.css">
  <link rel="stylesheet" href="/css/buttons.css">
  <link rel="stylesheet" href="/css/forms.css">
  <link rel="stylesheet" href="/css/modals.css">

  <style>
    body {
      background: var(--bg-primary);
      color: var(--text-primary);
      font-family: var(--font-family);
      margin: 0;
      padding: 0;
    }

    .demo-controls {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 9999;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-color);
      padding: 12px 20px;
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .demo-controls label {
      font-weight: 500;
    }

    .demo-controls select {
      padding: 6px 12px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border-color);
      background: var(--bg-tertiary);
      color: var(--text-primary);
      font-size: 14px;
    }

    .demo-controls .reload-button {
      padding: 6px 16px;
      border-radius: var(--radius-sm);
      border: none;
      background: var(--accent);
      color: white;
      cursor: pointer;
      font-size: 14px;
    }

    .demo-controls .reload-button:hover {
      background: var(--accent-hover);
    }

    .demo-container {
      margin-top: 60px;
      padding: 20px;
    }

    .demo-info {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      padding: 16px;
      margin-bottom: 20px;
    }

    .demo-info h2 {
      margin: 0 0 8px 0;
      font-size: 18px;
    }

    .demo-info p {
      margin: 0;
      color: var(--text-secondary);
      font-size: 14px;
    }

    .component-wrapper {
      border: 2px dashed var(--border-color);
      border-radius: var(--radius-md);
      padding: 20px;
      min-height: 100px;
    }

    .component-wrapper.no-padding {
      padding: 0;
    }

    /* Status bar needs to be at bottom for realistic view */
    .component-wrapper.status-bar-wrapper {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      border: none;
      border-radius: 0;
      padding: 0;
      min-height: auto;
    }

    /* Header needs to be at top */
    .component-wrapper.header-wrapper {
      position: fixed;
      top: 60px;
      left: 0;
      right: 0;
      border: none;
      border-radius: 0;
      padding: 0;
      min-height: auto;
    }
  </style>
</head>
<body>
  <div class="demo-controls">
    <label for="component-select">Component:</label>
    <select id="component-select">
      <option value="">-- Select Component --</option>
      <option value="hero-status-bar">hero-status-bar</option>
      <option value="hero-header">hero-header</option>
      <option value="hero-main-controls">hero-main-controls</option>
      <option value="hero-input">hero-input</option>
      <option value="hero-app">hero-app</option>
      <option value="hero-modal">hero-modal</option>
      <option value="hero-modal-new-session">hero-modal-new-session</option>
      <option value="hero-modal-abilities">hero-modal-abilities</option>
      <option value="hero-modal-agents">hero-modal-agents</option>
      <option value="hero-modal-agent-config">hero-modal-agent-config</option>
      <option value="hero-modal-new-agent">hero-modal-new-agent</option>
      <option value="hml-prompt">hml-prompt</option>
      <option value="hero-chat">hero-chat</option>
      <option value="hero-sessions-list">hero-sessions-list</option>
    </select>
    <button class="reload-button" onclick="loadComponent()">Reload</button>
  </div>

  <div class="demo-container">
    <div class="demo-info">
      <h2 id="component-title">No Component Selected</h2>
      <p id="component-description">Select a component from the dropdown above to preview it.</p>
    </div>
    <div id="component-wrapper" class="component-wrapper">
      <!-- Component will be inserted here -->
    </div>
  </div>

  <!-- Mythix UI Core -->
  <script type="importmap">
  {
    "imports": {
      "@cdn/mythix-ui-core@1": "/mythix-ui/mythix-ui-core/dist/index.js",
      "@cdn/mythix-ui-for-each@1": "/mythix-ui/mythix-ui-for-each/dist/mythix-ui-for-each.js",
      "@cdn/mythix-ui-modal@1": "/mythix-ui/mythix-ui-modal/dist/mythix-ui-modal.js",
      "@hero/api": "/js/api.js",
      "@hero/base": "/js/components/hero-base.js",
      "@hero/state": "/js/state.js",
      "@hero/utils": "/js/utils.js"
    }
  }
  </script>

  <!-- Mythix UI Configuration -->
  <script>
    // Wait for mythixUI to be available
    document.addEventListener('DOMContentLoaded', () => {
      if (typeof mythixUI !== 'undefined') {
        // Disable strict mode to allow complex template expressions
        mythixUI.strictMode = false;

        // Resolver for <mythix-require> component loading
        mythixUI.urlResolver = ({ src, path, fileName }) => {
          // Handle @cdn/hero-* pattern for hero components
          let heroMatch = src.match(/^@cdn\/(hero-[\w-]+)(@[\d.]+)?$/);
          if (heroMatch)
            return `/js/components/${heroMatch[1]}/${heroMatch[1]}.html`;

          // Handle @cdn/hml-prompt pattern
          if (src.match(/^@cdn\/hml-prompt(@[\d.]+)?$/))
            return `/js/components/hml-prompt/hml-prompt.html`;

          // Handle mythix-ui packages
          let mythixMatch = src.match(/^@cdn\/(mythix-ui-[\w-]+)(@[\d.]+)?$/);
          if (mythixMatch)
            return `/mythix-ui/${mythixMatch[1]}/dist/${mythixMatch[1]}.html`;

          return src;
        };
      }
    });
  </script>

  <script type="module">
    import { DynamicProperty, Utils } from '@cdn/mythix-ui-core@1';

    // Component metadata for demo
    // 'html' = uses <mythix-require> to load HTML (split-file pattern)
    // 'module' = direct JS import (single-file pattern, legacy)
    const componentInfo = {
      'hero-status-bar': {
        title: 'Hero Status Bar',
        description: 'Bottom status bar showing connection status and spend tracking.',
        wrapper: 'status-bar-wrapper',
        html: '/js/components/hero-status-bar/hero-status-bar.html',
      },
      'hero-header': {
        title: 'Hero Header',
        description: 'Top header bar with navigation and controls.',
        wrapper: 'header-wrapper',
        html: '/js/components/hero-header/hero-header.html',
        deps: ['/js/components/hero-main-controls/hero-main-controls.html'],
      },
      'hero-main-controls': {
        title: 'Hero Main Controls',
        description: 'Action buttons for header (Agents, Abilities, New Session, etc.).',
        wrapper: '',
        html: '/js/components/hero-main-controls/hero-main-controls.html',
      },
      'hero-input': {
        title: 'Hero Input',
        description: 'Message input textarea with send/clear buttons.',
        wrapper: '',
        html: '/js/components/hero-input/hero-input.html',
      },
      'hero-app': {
        title: 'Hero App',
        description: 'Main app orchestrator component.',
        wrapper: 'no-padding',
        html: '/js/components/hero-app/hero-app.html',
      },
      'hero-modal-session': {
        title: 'Hero Modal: New Session',
        description: 'Modal for creating a new session.',
        wrapper: '',
        html: '/js/components/hero-modal/hero-modal.html',
      },
      'hero-modal-abilities': {
        title: 'Hero Modal: Abilities',
        description: 'Modal showing system and user abilities.',
        wrapper: '',
        html: '/js/components/hero-modal/hero-modal.html',
      },
      'hero-modal-agents': {
        title: 'Hero Modal: Agents',
        description: 'Modal for managing agents.',
        wrapper: '',
        html: '/js/components/hero-modal/hero-modal.html',
      },
      'hero-modal-agent-config': {
        title: 'Hero Modal: Agent Config',
        description: 'Modal for editing agent configuration.',
        wrapper: '',
        html: '/js/components/hero-modal/hero-modal.html',
      },
      'hero-modal-agent': {
        title: 'Hero Modal: New Agent',
        description: 'Modal for creating a new agent.',
        wrapper: '',
        html: '/js/components/hero-modal/hero-modal.html',
      },
      'hml-prompt': {
        title: 'HML Prompt',
        description: 'Inline prompt component for user input.',
        wrapper: '',
        html: '/js/components/hml-prompt/hml-prompt.html',
      },
      'hero-chat': {
        title: 'Hero Chat',
        description: 'Chat view with message list and HML rendering.',
        wrapper: 'no-padding',
        html: '/js/components/hero-chat/hero-chat.html',
      },
      'hero-sessions-list': {
        title: 'Hero Sessions List',
        description: 'Sidebar list of sessions.',
        wrapper: '',
        module: '/js/components/hero-sessions-list/hero-sessions-list.js',
      },
    };

    // Setup mock GlobalState for testing
    async function setupMockState() {
      const { GlobalState } = await import('/js/components/hero-base.js');

      // Set mock data
      GlobalState.user[DynamicProperty.set]({ id: 1, username: 'demo' });
      GlobalState.wsConnected[DynamicProperty.set](true);
      GlobalState.globalSpend[DynamicProperty.set]({ cost: 12.34, inputTokens: 50000, outputTokens: 25000 });
      GlobalState.sessions[DynamicProperty.set]([
        { id: 1, name: 'Test Session 1', status: 'active', agent: { name: 'Claude' } },
        { id: 2, name: 'Test Session 2', status: 'active', agent: { name: 'Assistant' } },
        { id: 3, name: 'Archived Session', status: 'archived', agent: { name: 'Claude' } },
      ]);
      GlobalState.agents[DynamicProperty.set]([
        { id: 1, name: 'Claude', model: 'claude-3-opus' },
        { id: 2, name: 'Assistant', model: 'claude-3-sonnet' },
      ]);
      GlobalState.abilities[DynamicProperty.set]({
        system: [
          { id: 1, name: 'websearch', description: 'Search the web' },
          { id: 2, name: 'bash', description: 'Execute bash commands' },
        ],
        user: [
          { id: 101, name: 'my-ability', description: 'Custom ability' },
        ],
      });
      GlobalState.currentSession[DynamicProperty.set]({
        id: 1,
        name: 'Test Session 1',
        status: 'active',
        agent: { id: 1, name: 'Claude', model: 'claude-3-opus' },
        messages: [
          { id: 1, role: 'user', content: 'Hello! Can you help me with a coding question?', createdAt: new Date(Date.now() - 60000).toISOString() },
          { id: 2, role: 'assistant', content: 'Of course! I\'d be happy to help you with your coding question. What would you like to know?', createdAt: new Date(Date.now() - 55000).toISOString() },
          { id: 3, role: 'user', content: 'How do I create a web component?', createdAt: new Date(Date.now() - 30000).toISOString() },
        ],
      });

      return GlobalState;
    }

    // Load component by name
    async function loadComponent(componentName) {
      const name = componentName || document.getElementById('component-select').value;
      if (!name)
        return;

      const info = componentInfo[name];
      if (!info) {
        console.error(`Unknown component: ${name}`);
        return;
      }

      // Update URL
      const url = new URL(window.location);
      url.searchParams.set('component', name);
      window.history.replaceState({}, '', url);

      // Update info display
      document.getElementById('component-title').textContent = info.title;
      document.getElementById('component-description').textContent = info.description;

      // Update wrapper class
      const wrapper = document.getElementById('component-wrapper');
      wrapper.className = 'component-wrapper ' + (info.wrapper || '');

      // Setup mock state
      await setupMockState();

      // Clear and load component
      wrapper.innerHTML = '';

      try {
        // Load dependencies first
        if (info.deps) {
          for (const depHtml of info.deps) {
            const existingDep = document.querySelector(`mythix-require[src="${depHtml}"]`);
            if (!existingDep) {
              const requireEl = document.createElement('mythix-require');
              requireEl.setAttribute('src', depHtml);
              document.body.appendChild(requireEl);
            }
          }
          // Give dependencies time to register
          await new Promise((resolve) => setTimeout(resolve, 100));
        }

        // Load the component - either via HTML (split-file) or JS (single-file)
        if (info.html) {
          // Split-file pattern: use mythix-require to load HTML
          // First check if already loaded
          const existingRequire = document.querySelector(`mythix-require[src="${info.html}"]`);
          if (!existingRequire) {
            const requireEl = document.createElement('mythix-require');
            requireEl.setAttribute('src', info.html);
            document.body.appendChild(requireEl);
            // Wait for component to be defined
            await customElements.whenDefined(name);
          }
        } else if (info.module) {
          // Single-file pattern: direct JS import
          await import(info.module);
        }

        // Create the component element
        const element = document.createElement(name);

        // Special handling for modals - they need to be opened
        if (name.startsWith('hero-modal')) {
          wrapper.appendChild(element);
          // Give it a moment to mount, then open
          setTimeout(() => {
            if (element.open) {
              element.open();
            } else if (element.showModal) {
              element.showModal();
            }
          }, 100);
        } else if (name === 'hml-prompt') {
          // HML prompt needs attributes
          element.setAttribute('type', 'text');
          element.setAttribute('id', 'demo-prompt');
          element.textContent = 'What is your name?';
          wrapper.appendChild(element);
        } else {
          wrapper.appendChild(element);
        }

        console.log(`Loaded component: ${name}`);
      } catch (error) {
        console.error(`Failed to load component: ${name}`, error);
        wrapper.innerHTML = `<div style="color: var(--error); padding: 20px;">
          <strong>Error loading component:</strong><br>
          ${error.message}<br><br>
          <small>Check console for details. The component may not be converted yet.</small>
        </div>`;
      }
    }

    // Expose to global scope for button onclick
    window.loadComponent = loadComponent;

    // Handle dropdown change
    document.getElementById('component-select').addEventListener('change', (e) => {
      if (e.target.value) {
        loadComponent(e.target.value);
      }
    });

    // Load from URL param on page load
    document.addEventListener('DOMContentLoaded', () => {
      const params = new URLSearchParams(window.location.search);
      const component = params.get('component');
      if (component) {
        document.getElementById('component-select').value = component;
        loadComponent(component);
      }
    });
  </script>
</body>
</html>
